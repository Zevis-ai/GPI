<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ההזמנות שלי</title>
    <style>
        .order {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .order-id {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .order-status {
            color: green;
        }
        .status-pending { color: orange; }
        .status-completed { color: green; }
        .status-cancelled { color: red; }
        .no-orders {
            font-size: 18px;
            color: #666;
        }
        #loading {
            display: block;
            text-align: center;
            margin-top: 20px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<div id="profile">
    <img id="profile-picture" src="default-profile.png" alt="Profile Picture" width="100">
    <h2 id="user-greeting">שלום, משתמש</h2>
    <p id="user-email"></p>
</div>

<div id="orders-container"></div>
<div id="loading">טוען הזמנות...</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAaOp49avUlLknLkGzskeCPCk9xPOAeMUE",
        authDomain: "gpi0-d1e6d.firebaseapp.com",
        databaseURL: "https://gpi0-d1e6d-default-rtdb.firebaseio.com",
        projectId: "gpi0-d1e6d",
        storageBucket: "gpi0-d1e6d.appspot.com",
        messagingSenderId: "138797690477",
        appId: "1:138797690477:web:5d04dd40ed2a577dbed964",
        measurementId: "G-DP0JJ2FX3D"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const database = firebase.database();

    auth.onAuthStateChanged(user => {
        if (user) {
            const profilePicture = document.getElementById('profile-picture');
            const userGreeting = document.getElementById('user-greeting');
            const userEmail = document.getElementById('user-email');

            profilePicture.src = user.photoURL || 'default-profile.png';
            userGreeting.textContent = `שלום, ${user.displayName || 'משתמש'}`;
            userEmail.textContent = user.email;

            loadUserOrders(user.email);
        } else {
            window.location.href = "https://zevis-ai.github.io/GPI/login.html";
        }
    });

    function loadUserOrders(email) {
        const ordersRef = database.ref('orders');
        ordersRef.orderByChild('userEmail').equalTo(email).on('value', (snapshot) => {
            const ordersContainer = document.getElementById('orders-container');
            const loadingElement = document.getElementById('loading');
            
            // Hide loading spinner
            loadingElement.style.display = 'none';
            
            ordersContainer.innerHTML = '';

            const orders = [];
            snapshot.forEach((childSnapshot) => {
                orders.push({ key: childSnapshot.key, ...childSnapshot.val() });
            });

            if (orders.length === 0) {
                ordersContainer.innerHTML = '<p class="no-orders">אין הזמנות להצגה כרגע.</p>';
            } else {
                orders.forEach((order) => {
                    const orderElement = createOrderElement(order, order.key);
                    ordersContainer.appendChild(orderElement);
                });
            }
        });
    }

    function createOrderElement(order, orderId) {
        const orderDiv = document.createElement('div');
        orderDiv.className = 'order';
        orderDiv.innerHTML = `
            <span class="order-id">הזמנה מספר: ${orderId}</span>
            <span class="order-date">תאריך: ${new Date(order.date).toLocaleDateString('he-IL')}</span>
            <span class="order-status ${getStatusClass(order.status)}">${getStatusText(order.status)}</span>
            <p class="order-details">
                <strong>שם המוצר:</strong> ${order.productName}<br>
                <strong>קטגוריה:</strong> ${order.productCategory}<br>
                <strong>תיאור:</strong> ${order.productDescription}<br>
                <strong>חומרים:</strong> ${order.productMaterials}<br>
                <strong>כמות:</strong> ${order.productQuantity}<br>
                <strong>מחיר משוער:</strong> ${order.estimatedPrice}<br>
                <strong>תאריך משלוח:</strong> ${new Date(order.deliveryDate).toLocaleDateString('he-IL')}<br>
                <strong>דרישות נוספות:</strong> ${order.additionalRequirements}<br>
                <strong>שם איש קשר:</strong> ${order.contactName}<br>
                <strong>אימייל איש קשר:</strong> ${order.contactEmail}<br>
                <strong>טלפון איש קשר:</strong> ${order.contactPhone}<br>
            </p>
        `;
        return orderDiv;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'pending': return 'status-pending';
            case 'completed': return 'status-completed';
            case 'cancelled': return 'status-cancelled';
            default: return '';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'pending': return 'ממתין';
            case 'completed': return 'הושלם';
            case 'cancelled': return 'בוטל';
            default: return status;
        }
    }
</script>
</body>
</html>
